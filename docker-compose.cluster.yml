version: '3.8'

# Full sentinel stack: Redis Sentinel (1 master + 2 replicas + 3 sentinels) + PostgreSQL + Kafka + 3 API replicas + Nginx
#
# Usage:
#   docker compose -f docker-compose.cluster.yml up -d
#
# Scale API instances:
#   docker compose -f docker-compose.cluster.yml up -d --scale api=5
#
# Verify Sentinel:
#   docker exec sentinel-1 redis-cli -p 26379 sentinel masters
#   docker exec sentinel-1 redis-cli -p 26379 sentinel replicas mymaster
#   docker exec sentinel-1 redis-cli -p 26379 sentinel get-master-addr-by-name mymaster
#
# Tear down + wipe data:
#   docker compose -f docker-compose.cluster.yml down -v

services:
  # ── Load Balancer ─────────────────────────────────────────────────────────

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - '3333:80'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - sentinel-network
    depends_on:
      - api
    restart: always

  # ── API (3 replicas) ──────────────────────────────────────────────────────

  api:
    build:
      context: .
      dockerfile: ./Dockerfile
    restart: always
    volumes:
      - .:/usr/src/app
    environment:
      - NODE_ENV=development
      - PORT=3333
      - DATABASE_URL=postgresql://postgres:password@db-primary:5432/db
      - DATABASE_REPLICA_URL=postgresql://postgres:password@db-replica-1:5432/db
      - BETTER_AUTH_URL=http://localhost:3000
      - BETTER_AUTH_SECRET=secret
      - REDIS_SENTINEL_NODES=sentinel-1:26379,sentinel-2:26379,sentinel-3:26379
      - REDIS_SENTINEL_NAME=mymaster
      - KAFKA_BROKERS=kafka:9093
      - FALLBACK_LANGUAGE=en
    networks:
      - sentinel-network
      - database-network
    depends_on:
      sentinel-1:
        condition: service_healthy
      db-primary:
        condition: service_healthy
      db-replica-1:
        condition: service_healthy
      kafka:
        condition: service_healthy
    deploy:
      replicas: 3

  # ── PostgreSQL Primary ────────────────────────────────────────────────────

  db-primary:
    image: bitnami/postgresql
    container_name: db-primary
    attach: false
    ports:
      - '5432:5432'
    restart: always
    volumes:
      - postgres-primary-data:/bitnami/postgresql
    environment:
      - POSTGRESQL_REPLICATION_MODE=master
      - POSTGRESQL_REPLICATION_USER=replicator
      - POSTGRESQL_REPLICATION_PASSWORD=replicapassword
      - POSTGRESQL_USERNAME=postgres
      - POSTGRESQL_PASSWORD=password
      - POSTGRESQL_DATABASE=db
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d db || exit 1']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - database-network

  # ── PostgreSQL Replica ────────────────────────────────────────────────────

  db-replica-1:
    image: bitnami/postgresql
    container_name: db-replica-1
    attach: false
    ports:
      - '5433:5432'
    restart: always
    volumes:
      - postgres-replica-1-data:/bitnami/postgresql
    environment:
      - POSTGRESQL_REPLICATION_MODE=slave
      - POSTGRESQL_MASTER_HOST=db-primary
      - POSTGRESQL_MASTER_PORT_NUMBER=5432
      - POSTGRESQL_REPLICATION_USER=replicator
      - POSTGRESQL_REPLICATION_PASSWORD=replicapassword
      - POSTGRESQL_PASSWORD=password
    depends_on:
      db-primary:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres || exit 1']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - database-network

  # ── Kafka (Redpanda) ──────────────────────────────────────────────────────

  kafka:
    image: redpandadata/redpanda:v23.2.25
    container_name: kafka
    ports:
      - '9092:9092'
      - '9644:9644'
    networks:
      - sentinel-network
    deploy:
      resources:
        limits:
          memory: 1G
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9093,external://0.0.0.0:9092
      - --advertise-kafka-addr internal://kafka:9093,external://localhost:9092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:8083
      - --advertise-pandaproxy-addr internal://kafka:8082,external://localhost:8083
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:8084
      - --rpc-addr kafka:33145
      - --advertise-rpc-addr kafka:33145
      - --smp 1
      - --memory 1G
      - --mode dev-container
      - --default-log-level=info
    healthcheck:
      test:
        ['CMD-SHELL', "rpk cluster health | grep -E 'Healthy:.+true' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ── Redis Master ──────────────────────────────────────────────────────────

  redis-master:
    image: redis:7-alpine
    container_name: redis-master
    ports:
      - '7001:6379'
    volumes:
      - redis-master-data:/data
    networks:
      - sentinel-network
    restart: unless-stopped
    command: >
      redis-server
      --port 6379
      --appendonly yes
      --appendfsync everysec
    healthcheck:
      test: ['CMD', 'redis-cli', '-p', '6379', 'ping']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ── Redis Replicas ────────────────────────────────────────────────────────

  redis-replica-1:
    image: redis:7-alpine
    container_name: redis-replica-1
    ports:
      - '7002:6379'
    volumes:
      - redis-replica-1-data:/data
    networks:
      - sentinel-network
    restart: unless-stopped
    depends_on:
      redis-master:
        condition: service_healthy
    command: >
      redis-server
      --port 6379
      --replicaof redis-master 6379
      --appendonly yes
      --appendfsync everysec
    healthcheck:
      test: ['CMD', 'redis-cli', '-p', '6379', 'ping']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  redis-replica-2:
    image: redis:7-alpine
    container_name: redis-replica-2
    ports:
      - '7003:6379'
    volumes:
      - redis-replica-2-data:/data
    networks:
      - sentinel-network
    restart: unless-stopped
    depends_on:
      redis-master:
        condition: service_healthy
    command: >
      redis-server
      --port 6379
      --replicaof redis-master 6379
      --appendonly yes
      --appendfsync everysec
    healthcheck:
      test: ['CMD', 'redis-cli', '-p', '6379', 'ping']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ── Redis Sentinel (3 nodes, quorum = 2) ──────────────────────────────────

  sentinel-1:
    image: redis:7-alpine
    container_name: sentinel-1
    ports:
      - '26380:26379'
    networks:
      - sentinel-network
    restart: unless-stopped
    depends_on:
      redis-master:
        condition: service_healthy
    entrypoint: ['/bin/sh', '-c']
    command:
      - |
        mkdir -p /tmp/sentinel
        printf 'port 26379\nsentinel monitor mymaster redis-master 6379 2\nsentinel down-after-milliseconds mymaster 5000\nsentinel failover-timeout mymaster 10000\nsentinel parallel-syncs mymaster 1\nsentinel announce-hostnames yes\nsentinel resolve-hostnames yes\n' > /tmp/sentinel/sentinel.conf
        exec redis-sentinel /tmp/sentinel/sentinel.conf
    healthcheck:
      test: ['CMD', 'redis-cli', '-p', '26379', 'ping']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  sentinel-2:
    image: redis:7-alpine
    container_name: sentinel-2
    ports:
      - '26381:26379'
    networks:
      - sentinel-network
    restart: unless-stopped
    depends_on:
      redis-master:
        condition: service_healthy
    entrypoint: ['/bin/sh', '-c']
    command:
      - |
        mkdir -p /tmp/sentinel
        printf 'port 26379\nsentinel monitor mymaster redis-master 6379 2\nsentinel down-after-milliseconds mymaster 5000\nsentinel failover-timeout mymaster 10000\nsentinel parallel-syncs mymaster 1\nsentinel announce-hostnames yes\nsentinel resolve-hostnames yes\n' > /tmp/sentinel/sentinel.conf
        exec redis-sentinel /tmp/sentinel/sentinel.conf
    healthcheck:
      test: ['CMD', 'redis-cli', '-p', '26379', 'ping']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  sentinel-3:
    image: redis:7-alpine
    container_name: sentinel-3
    ports:
      - '26382:26379'
    networks:
      - sentinel-network
    restart: unless-stopped
    depends_on:
      redis-master:
        condition: service_healthy
    entrypoint: ['/bin/sh', '-c']
    command:
      - |
        mkdir -p /tmp/sentinel
        printf 'port 26379\nsentinel monitor mymaster redis-master 6379 2\nsentinel down-after-milliseconds mymaster 5000\nsentinel failover-timeout mymaster 10000\nsentinel parallel-syncs mymaster 1\nsentinel announce-hostnames yes\nsentinel resolve-hostnames yes\n' > /tmp/sentinel/sentinel.conf
        exec redis-sentinel /tmp/sentinel/sentinel.conf
    healthcheck:
      test: ['CMD', 'redis-cli', '-p', '26379', 'ping']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

volumes:
  postgres-primary-data:
    driver: local
  postgres-replica-1-data:
    driver: local
  redis-master-data:
    driver: local
  redis-replica-1-data:
    driver: local
  redis-replica-2-data:
    driver: local

networks:
  sentinel-network:
    driver: bridge
  database-network:
    driver: bridge
